<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Workflowy Sender</title>
<style>
  :root {
    --bg-color: #f0f2f5;
    --app-bg: #ffffff;
    --text-color: #333;
    --border-color: #ddd;
    --primary-color: #2b2b2b;
    --accent-color: #007bff;
    --danger-color: #dc3545;
    --header-height: 40px;
    --footer-height: 60px;
    --app-max-width: 600px;
  }

  * { box-sizing: border-box; touch-action: manipulation; }
  
  body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    height: 100vh; 
    display: flex;
    justify-content: center;
    position: relative; 
    overflow: hidden; 
  }

  .app-container {
    width: 100%;
    max-width: var(--app-max-width);
    height: 100%; 
    background-color: var(--app-bg);
    display: flex;
    flex-direction: column;
    position: relative;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
  }

  /* --- Header --- */
  .header {
    height: var(--header-height);
    background: var(--app-bg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    flex-shrink: 0;
    z-index: 10;
  }

  .app-title {
    font-size: 14px;
    font-weight: bold;
    color: var(--primary-color);
  }

  .char-count {
    font-size: 12px;
    color: #888;
  }

  /* --- Main Editor Area --- */
  .main-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 15px;
    padding-bottom: calc(15px + var(--footer-height)); 
    background: var(--app-bg);
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch;
  }

  .editor-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  textarea {
    width: 100%;
    border: none;
    outline: none;
    resize: none;
    font-family: inherit;
    background: transparent;
    display: block;
    padding: 0;
    -webkit-user-select: text;
    user-select: text;
    -webkit-tap-highlight-color: transparent;
  }

  #editor-main {
    flex: 1;
    font-size: 16px; 
    line-height: 1.6;
  }

  /* --- Bottom Bar --- */
  .bottom-bar {
    height: var(--footer-height);
    background: #f8f9fa;
    border-top: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    flex-shrink: 0;
    gap: 8px;
    position: fixed;
    bottom: 0;
    width: 100%;
    max-width: var(--app-max-width);
    z-index: 100;
    transition: bottom 0.2s ease-out; 
  }

  .btn-group { 
    display: flex; 
    gap: 8px;
    align-items: center;
  }

  .btn {
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    font-size: 15px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
  }
  
  .btn-primary { background: var(--primary-color); color: #fff; }
  .btn-primary:active { opacity: 0.8; }
  .btn-primary:disabled { background: #999; cursor: not-allowed; }
  
  .btn-danger { background: transparent; color: var(--danger-color); }
  .btn-secondary { background: transparent; color: #555; }
  .btn-icon { background: transparent; color: #555; padding: 8px; }

  @media (max-width: 600px) {
    .btn-text { display: none; }
    .btn { padding: 8px; font-size: 16px; }
    .bottom-bar {
      max-width: 100%; 
    }
  }

  @media (min-width: 601px) {
    .btn-text { display: none; }
    .btn-icon { display: inline; }
    .bottom-bar {
      flex-wrap: nowrap;
    }
  }

  /* --- Dropdown Menu --- */
  .dropdown-menu {
    position: absolute;
    bottom: calc(var(--footer-height) + 5px); 
    left: 80px;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
    display: none;
    flex-direction: column;
    z-index: 999;
    max-height: 200px;
    overflow-y: auto;
  }

  .dropdown-menu.active { display: flex; }

  .dropdown-item {
    padding: 10px 15px;
    border: none;
    background: transparent;
    cursor: pointer;
    text-align: left;
    font-size: 14px;
    transition: background 0.2s;
  }

  .dropdown-item:hover { background: #f0f0f0; }
  .dropdown-item:active { background: #e0e0e0; }

  /* --- Options Panel --- */
  .options-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 1000;
    overflow: hidden;
  }

  .options-panel.active { display: flex; }

  .options-content {
    background: #fff;
    width: 100%;
    height: 100%;
    max-width: var(--app-max-width); 
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  @media (min-width: 601px) {
    .options-panel.active { align-items: center; justify-content: center; }
    .options-content { height: 90%; border-radius: 8px; }
  }


  .options-header {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    background: var(--app-bg);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .options-header h3 {
    margin: 0;
    font-size: 18px;
  }

  .options-body {
    flex: 1;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    overflow-y: auto;
  }

  .options-section {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .options-section-title {
    font-size: 14px;
    font-weight: bold;
    color: #555;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
  }

  .options-footer {
    padding: 15px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    flex-shrink: 0;
    background: var(--app-bg);
    position: sticky;
    bottom: 0;
    z-index: 10;
  }

  h3 { margin: 0 0 10px 0; font-size: 18px; }

  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-label { font-size: 12px; font-weight: bold; color: #555; }
  .form-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }

  .template-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .template-item {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .template-item-header {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .template-item input {
    flex: 1;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 12px;
  }

  .template-item textarea {
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
    height: 60px;
    resize: vertical;
  }

  .btn-remove { background: var(--danger-color); color: white; padding: 4px 8px; font-size: 12px; }
  .btn-add-tpl { background: var(--accent-color); color: white; padding: 8px 12px; font-size: 12px; }

  .toast {
    position: fixed; bottom: calc(var(--footer-height) + 30px); left: 50%; transform: translateX(-50%);
    background: rgba(40,40,40,0.9); color: white;
    padding: 8px 16px; border-radius: 20px; font-size: 14px;
    opacity: 0; transition: opacity 0.3s; pointer-events: none;
    white-space: nowrap; z-index: 999;
  }
  .toast.show { opacity: 1; }

  .spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%; border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-right: 6px; display: none;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
  }

  /* iOSÂØæÁ≠ñ: „Çª„Éº„Éï„Ç®„É™„Ç¢„ÅÆ„Ç§„É≥„Çª„ÉÉ„Éà„ÇíËÄÉÊÖÆÔºàJS„Åß‰∏äÊõ∏„Åç„Åï„Çå„Çã„ÅåÂøµ„ÅÆ„Åü„ÇÅÔºâ */
  @supports (padding: max(0px)) {
    .bottom-bar {
      padding-bottom: max(8px, env(safe-area-inset-bottom));
    }
  }

</style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <div class="app-title">Workflowy sender</div>
    <div class="char-count">c:<span id="char-count">0</span></div>
  </div>

  <div class="main-area">
    <div class="editor-wrapper">
      <textarea id="editor-main" placeholder="ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
    </div>
  </div>

  <div class="bottom-bar">
    <div class="btn-group">
      <button class="btn btn-icon btn-secondary" id="btn-date" title="Êó•‰ªò">üìÖ</button>
      <button class="btn btn-icon btn-secondary" id="btn-time-toggle" title="ÊôÇÂàª">‚è∞</button>
      <button class="btn btn-icon btn-secondary" id="btn-templates" title="„ÉÜ„É≥„Éó„É¨„Éº„Éà">üìã</button>
      <button class="btn btn-icon btn-danger" id="btn-clear" title="ÂÖ®ÂâäÈô§">üóëÔ∏è</button>
    </div>
    <div class="btn-group">
      <button class="btn btn-secondary" id="btn-options">
        <span class="btn-text">‚öôÔ∏è Ë®≠ÂÆö</span>
        <span class="btn-icon">‚öôÔ∏è</span>
      </button>
      <button class="btn btn-primary" id="btn-send">
        <div class="spinner" id="loading-spinner"></div>
        <span>ÈÄÅ‰ø°</span>
      </button>
    </div>
  </div>

  <div class="dropdown-menu" id="templates-menu"></div>
  <div class="toast" id="toast"></div>
</div>

<div class="options-panel" id="options-modal">
  <div class="options-content">
    <div class="options-header">
      <h3>Ë®≠ÂÆö</h3>
      <button class="btn btn-secondary" id="btn-close-opt">‚úï</button>
    </div>

    <div class="options-body">
      <div class="options-section">
        <div class="options-section-title">API„Ç≠„Éº</div>
        <div class="form-group">
          <label class="form-label">Workflowy API Key (ÂøÖÈ†à)</label>
          <input type="password" class="form-input" id="opt-apikey" placeholder="API Key„ÇíË≤º„Çä‰ªò„Åë">
        </div>
      </div>

      <div class="options-section">
        <div class="options-section-title">ÈÄÅ‰ø°Ë®≠ÂÆö</div>
        <div class="form-group">
          <label class="form-label">Ë¶™„Éé„Éº„ÉâID („Éá„Éï„Ç©„É´„Éà: inbox)</label>
          <input type="text" class="form-input" id="opt-parentid" placeholder="inbox, home, etc...">
        </div>

        <div class="form-group">
          <label class="form-label">ÈÄÅ‰ø°‰ΩçÁΩÆ</label>
          <select class="form-input" id="opt-position">
            <option value="top">Top (‰∏ä„Å´ËøΩÂä†)</option>
            <option value="bottom">Bottom (‰∏ã„Å´ËøΩÂä†)</option>
          </select>
        </div>
      </div>

      <div class="options-section">
        <div class="options-section-title">„Ç®„Éá„Ç£„ÇøË®≠ÂÆö</div>
        <div class="form-group">
          <label class="form-label">„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫ (px)</label>
          <input type="number" class="form-input" id="opt-fontsize" min="12" max="24" value="16">
        </div>
      </div>

      <div class="options-section">
        <div class="form-group">
          <label class="form-label">Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà (‰æã: [YYYY-MM-DD])</label>
          <input type="text" class="form-input" id="opt-datefmt">
        </div>

        <div class="form-group">
          <label class="form-label">ÊôÇÂàª„Éï„Ç©„Éº„Éû„ÉÉ„Éà (‰æã: [YYYY-MM-DD HH:mm])</label>
          <input type="text" class="form-input" id="opt-timefmt">
        </div>
      </div>

      <div class="options-section">
        <div class="options-section-title">„ÉÜ„É≥„Éó„É¨„Éº„Éà</div>
        <div class="template-list" id="template-list"></div>
        <button class="btn btn-add-tpl" id="btn-add-template">+ „ÉÜ„É≥„Éó„É¨„Éº„ÉàËøΩÂä†</button>
      </div>
    </div>

    <div class="options-footer">
      <button class="btn btn-secondary" id="btn-cancel-opt">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" id="btn-save-opt">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<script>
/**
 * Workflowy Sender v7.0
 * ‰øÆÊ≠£: 1. ÈÄÅ‰ø°„Éú„Çø„É≥„ÅÆmousedown„ÅßpreventDefault()„ÇíÂëº„Å≥Âá∫„Åó„ÄÅiOS„Åß„ÅÆ„Ç≠„Éº„Éú„Éº„ÉâÈùûË°®Á§∫„ÇíÊäëÂà∂
 * ‰øÆÊ≠£: 2. ÈÄÅ‰ø°ÂÆå‰∫Ü/„Ç®„É©„ÉºÊôÇ„Å´focus()„ÇíÂÜçÂÆüË°å„Åó„ÄÅÁ¢∫ÂÆü„Å´textarea„Å´„Ç´„Éº„ÇΩ„É´„ÇíÊàª„Åô
 */

const STORAGE_KEY = 'workflowy_sender_config_v4';
const API_URL = '/api/workflowy/nodes'; 

const DEFAULT_TEMPLATES = [
  { label: 'Ê®ôÊ∫ñ', text: '' },
  { label: 'Êó•Ë®ò', text: '{{date}} ' },
  { label: 'Todo', text: '- [ ] {{cursor}}' }
];

const DEFAULT_CONFIG = {
  apiKey: '',
  parentId: 'inbox',
  position: 'top',
  dateFormat: '[YYYY-MM-DD]',
  timeFormat: '[YYYY-MM-DD HH:mm]',
  fontSize: 16,
  templates: DEFAULT_TEMPLATES
};

let config = { ...DEFAULT_CONFIG };

let toggleState = {
  active: false,
  lastInsertedFormat: null, 
  cursorStart: 0,
  cursorEnd: 0
};


// --- DOM Elements ---
const dom = {
  editorMain: document.getElementById('editor-main'),
  btnSend: document.getElementById('btn-send'),
  btnClear: document.getElementById('btn-clear'),
  btnOptions: document.getElementById('btn-options'),
  btnDate: document.getElementById('btn-date'),
  btnTimeToggle: document.getElementById('btn-time-toggle'), 
  btnTemplates: document.getElementById('btn-templates'),
  modal: document.getElementById('options-modal'),
  btnSaveOpt: document.getElementById('btn-save-opt'),
  btnCancelOpt: document.getElementById('btn-cancel-opt'),
  btnCloseOpt: document.getElementById('btn-close-opt'),
  spinner: document.getElementById('loading-spinner'),
  toast: document.getElementById('toast'),
  charCount: document.getElementById('char-count'),
  optApiKey: document.getElementById('opt-apikey'),
  optParentId: document.getElementById('opt-parentid'),
  optPosition: document.getElementById('opt-position'),
  optDateFmt: document.getElementById('opt-datefmt'),
  optTimeFmt: document.getElementById('opt-timefmt'),
  optFontSize: document.getElementById('opt-fontsize'),
  templateList: document.getElementById('template-list'),
  btnAddTemplate: document.getElementById('btn-add-template'),
  templatesMenu: document.getElementById('templates-menu'),
  
  bottomBar: document.querySelector('.bottom-bar'), 
  mainArea: document.querySelector('.main-area'),
  appContainer: document.querySelector('.app-container'),
};

function init() {
  loadConfig();
  applyTemplate(config.templates[0]);
  applyFontSize();
  
  // Ëµ∑ÂãïÊôÇ„ÅÆËá™Âãï„Éï„Ç©„Éº„Ç´„ÇπÔºàiOS„ÅÆÂà∂Èôê„Å´„Çà„Çä„ÄÅ„É¶„Éº„Ç∂„ÉºÊìç‰Ωú„Å™„Åó„Åß„ÅÆËá™ÂãïËµ∑Âãï„ÅØÁ¢∫Á¥Ñ„Åß„Åç„Åæ„Åõ„ÇìÔºâ
  if (config.apiKey) {
    dom.editorMain.focus(); 
  } else {
    openOptions();
  }


  // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
  dom.btnSend.addEventListener('click', handleSend);
  
  // üåü ‰øÆÊ≠£1: iOS„Åß„ÅÆ„Éú„Çø„É≥„Çø„ÉÉ„Éó„Å´„Çà„Çã„Ç≠„Éº„Éú„Éº„ÉâÈùûË°®Á§∫„ÇíÈò≤„Åê
  // „Éú„Çø„É≥„ÅÆmousedown„Ç§„Éô„É≥„Éà„ÅßpreventDefault()„ÇíÂëº„Å∂„Åì„Å®„Åß„ÄÅ
  // focus„ÅÆÁßªÂãï„Å®textarea„Å∏„ÅÆblur„Ç§„Éô„É≥„Éà„ÅÆÁô∫Áîü„ÇíÊäëÂà∂„Åó„Åæ„Åô„ÄÇ
  dom.btnSend.addEventListener('mousedown', (e) => {
    e.preventDefault();
  });
  
  dom.btnClear.addEventListener('click', () => {
    dom.editorMain.value = '';
    dom.editorMain.focus();
    updateCharCount();
  });
  
  dom.btnOptions.addEventListener('click', openOptions);
  dom.btnSaveOpt.addEventListener('click', saveOptions);
  dom.btnCancelOpt.addEventListener('click', closeOptions);
  dom.btnCloseOpt.addEventListener('click', closeOptions);
  
  if (dom.btnDate) dom.btnDate.addEventListener('click', () => {
    insertDateTime(config.dateFormat);
    resetToggleState(); 
  }); 
  
  if (dom.btnTimeToggle) dom.btnTimeToggle.addEventListener('click', () => {
    insertDateTime(config.timeFormat);
    resetToggleState(); 
  }); 
  
  if (dom.btnTemplates) dom.btnTemplates.addEventListener('click', toggleTemplateMenu);
  dom.btnAddTemplate.addEventListener('click', addTemplateItem);

  dom.editorMain.addEventListener('keydown', handleKeydown);
  dom.editorMain.addEventListener('input', updateCharCount);
  
  dom.editorMain.addEventListener('click', resetToggleState);
  dom.editorMain.addEventListener('keyup', resetToggleState);
  
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', adjustBottomBarPosition);
    adjustBottomBarPosition();
  }
}

function adjustBottomBarPosition() {
  if (!window.visualViewport || !dom.bottomBar || !dom.mainArea || !dom.appContainer) return;
  
  const visualHeight = window.visualViewport.height;
  const innerHeight = window.innerHeight;
  const footerHeightCSS = getComputedStyle(document.documentElement).getPropertyValue('--footer-height');
  const footerHeight = parseFloat(footerHeightCSS.replace('px', ''));
  
  const isKeyboardOpen = Math.abs(visualHeight - innerHeight) > 50;

  if (isKeyboardOpen) {
    const kbHeight = innerHeight - visualHeight;
    
    dom.bottomBar.style.bottom = `${kbHeight}px`;

    dom.mainArea.style.paddingBottom = `${kbHeight + footerHeight + 15}px`;
    
  } else {
    dom.bottomBar.style.bottom = '0';
    dom.mainArea.style.paddingBottom = `calc(15px + var(--footer-height))`;
  }
}

function updateCharCount() {
  dom.charCount.textContent = dom.editorMain.value.length;
}

function applyFontSize() {
  const fontSize = config.fontSize || 16;
  dom.editorMain.style.fontSize = fontSize + 'px';
}

function handleKeydown(e) {
  if ((e.ctrlKey || e.altKey) && e.key === 'Enter') { 
    e.preventDefault();
    handleSend();
    return;
  }
  
  if (e.altKey && (e.key === 't' || e.key === 'T' || e.key === '√£‚Äπ')) { 
    e.preventDefault();
    insertDateOrTimeToggle(); 
    return;
  }
}

function resetToggleState() {
  const isInputActive = dom.editorMain === document.activeElement;
  if (!isInputActive) {
    toggleState.active = false;
    toggleState.lastInsertedFormat = null;
    return;
  }

  const currentCursor = dom.editorMain.selectionStart;
  if (toggleState.active && currentCursor !== toggleState.cursorEnd) {
    toggleState.active = false;
    toggleState.lastInsertedFormat = null;
  }
}

function loadConfig() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      config = { ...DEFAULT_CONFIG, ...parsed };
      if (!config.timeFormat) config.timeFormat = DEFAULT_CONFIG.timeFormat;
      if (!config.fontSize) config.fontSize = DEFAULT_CONFIG.fontSize;
    } catch (e) {
      console.error(e);
    }
  }
}

function saveConfigToStorage() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
}

function getFormattedDateTime(formatStr) {
  const now = new Date();
  const map = {
    'YYYY': now.getFullYear(),
    'YY': String(now.getFullYear()).slice(-2),
    'MM': String(now.getMonth() + 1).padStart(2, '0'),
    'M': now.getMonth() + 1,
    'DD': String(now.getDate()).padStart(2, '0'),
    'D': now.getDate(),
    'HH': String(now.getHours()).padStart(2, '0'),
    'H': now.getHours(),
    'mm': String(now.getMinutes()).padStart(2, '0'),
    'm': now.getMinutes()
  };

  let result = formatStr;
  const keys = Object.keys(map).sort((a, b) => b.length - a.length);
  keys.forEach(key => {
    result = result.replace(new RegExp(key, 'g'), map[key]);
  });
  return result;
}

function insertDateTime(formatStr) {
  const textArea = dom.editorMain;
  const insertStr = getFormattedDateTime(formatStr);
  const start = textArea.selectionStart;
  const end = textArea.selectionEnd;
  const value = textArea.value;

  textArea.value = value.substring(0, start) + insertStr + value.substring(end);
  
  const newCursorPos = start + insertStr.length;
  textArea.setSelectionRange(newCursorPos, newCursorPos);
  
  textArea.focus();
  updateCharCount();

  return { insertStr, start, end: newCursorPos };
}

function insertDateOrTimeToggle() {
  const textArea = dom.editorMain;
  let targetFormat = config.dateFormat; 

  if (toggleState.active && toggleState.lastInsertedFormat) {
    if (toggleState.lastInsertedFormat === config.dateFormat) {
      targetFormat = config.timeFormat;
    } else {
      targetFormat = config.dateFormat;
    }

    const start = toggleState.cursorStart;
    const end = toggleState.cursorEnd;
    const value = textArea.value;
    textArea.value = value.substring(0, start) + value.substring(end);
    textArea.setSelectionRange(start, start); 
  }

  const { insertStr, start, end: newCursorPos } = insertDateTime(targetFormat);

  toggleState.active = true;
  toggleState.cursorStart = start;
  toggleState.cursorEnd = newCursorPos;
  toggleState.lastInsertedFormat = targetFormat;
  
  setTimeout(() => {
    const currentCursorPos = textArea.selectionStart;
    if (currentCursorPos !== newCursorPos) {
      resetToggleState();
    }
  }, 100);
}


function convertToWorkflowyBullets(text) {
  if (!text) return "";
  return text.split('\n')
    .map(line => line.trim() ? `- ${line}` : '')
    .filter(line => line) 
    .join('\n\n');
}

function processPlaceholders(text) {
  if (!text) return "";
  let res = text;
  if (res.includes('{{date}}')) {
    res = res.replace(/{{date}}/g, getFormattedDateTime(config.dateFormat));
  }
  if (res.includes('{{time}}')) {
    res = res.replace(/{{time}}/g, getFormattedDateTime(config.timeFormat));
  }
  return res;
}

function applyTemplate(tpl) {
  if (!tpl) return;
  resetToggleState(); 
  let mainContent = processPlaceholders(tpl.text || '');
  const cursorMarker = '{{cursor}}';
  
  if (mainContent.includes(cursorMarker)) {
    const cursorIndex = mainContent.indexOf(cursorMarker);
    dom.editorMain.value = mainContent.replace(cursorMarker, '');
    dom.editorMain.setSelectionRange(cursorIndex, cursorIndex);
  } else {
    dom.editorMain.value = mainContent;
  }
  dom.editorMain.focus();
  updateCharCount();
}

function toggleTemplateMenu() {
  dom.templatesMenu.classList.toggle('active');
  renderTemplateMenu();
}

function renderTemplateMenu() {
  dom.templatesMenu.innerHTML = '';
  config.templates.forEach((tpl, idx) => {
    const btn = document.createElement('button');
    btn.className = 'dropdown-item';
    btn.textContent = tpl.label || `Tpl ${idx+1}`;
    btn.onclick = () => {
      applyTemplate(tpl);
      dom.templatesMenu.classList.remove('active');
    };
    dom.templatesMenu.appendChild(btn);
  });
}

function openOptions() {
  dom.optApiKey.value = config.apiKey || '';
  dom.optParentId.value = config.parentId || 'inbox';
  dom.optPosition.value = config.position || 'top';
  dom.optDateFmt.value = config.dateFormat || '[YYYY-MM-DD]';
  dom.optTimeFmt.value = config.timeFormat || '[YYYY-MM-DD HH:mm]';
  dom.optFontSize.value = config.fontSize || 16; 
  renderTemplateItems();
  dom.modal.classList.add('active');
  
  dom.editorMain.blur(); 
}

function closeOptions() {
  dom.modal.classList.remove('active');
  
  if (config.apiKey) {
    dom.editorMain.focus();
  }
}

function renderTemplateItems() {
  dom.templateList.innerHTML = '';
  config.templates.forEach((tpl, idx) => {
    const item = document.createElement('div');
    item.className = 'template-item';
    
    const header = document.createElement('div');
    header.className = 'template-item-header';
    
    const labelInput = document.createElement('input');
    labelInput.type = 'text';
    labelInput.placeholder = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç';
    labelInput.value = tpl.label || '';
    labelInput.style.flex = '1';
    
    const btnRemove = document.createElement('button');
    btnRemove.className = 'btn btn-remove';
    btnRemove.textContent = 'ÂâäÈô§';
    btnRemove.onclick = () => {
      config.templates.splice(idx, 1);
      renderTemplateItems();
    };
    
    header.appendChild(labelInput);
    header.appendChild(btnRemove);
    
    const textArea = document.createElement('textarea');
    textArea.placeholder = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂÜÖÂÆπ ({{date}}, {{time}}, {{cursor}} „Åå‰ΩøÁî®ÂèØËÉΩ)';
    textArea.value = tpl.text || '';
    
    item.appendChild(header);
    item.appendChild(textArea);
    
    labelInput.addEventListener('input', (e) => {
      config.templates[idx].label = e.target.value;
    });
    
    textArea.addEventListener('input', (e) => {
      config.templates[idx].text = e.target.value;
    });
    
    dom.templateList.appendChild(item);
  });
}

function addTemplateItem() {
  config.templates.push({ label: 'Êñ∞Ë¶è', text: '' });
  renderTemplateItems();
}

function saveOptions() {
  try {
    config.apiKey = dom.optApiKey.value.trim();
    config.parentId = dom.optParentId.value.trim() || 'inbox';
    config.position = dom.optPosition.value;
    config.dateFormat = dom.optDateFmt.value;
    config.timeFormat = dom.optTimeFmt.value;
    
    const newFontSize = parseInt(dom.optFontSize.value, 10);
    if (newFontSize >= 12 && newFontSize <= 24) {
      config.fontSize = newFontSize;
      applyFontSize(); 
    } else {
      config.fontSize = 16; 
      applyFontSize();
    }

    saveConfigToStorage();
    renderTemplateMenu();
    showToast('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
    closeOptions();
  } catch (e) {
    console.error(e);
    showToast('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
  }
}

async function handleSend() {
  const text = dom.editorMain.value;

  if (!text.trim()) {
    showToast('Êú¨Êñá„ÅåÁ©∫„Åß„Åô');
    return;
  }
  if (!config.apiKey) {
    showToast('API Key„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇË®≠ÂÆö„ÇíÈñã„Åç„Åæ„Åô„ÄÇ');
    openOptions();
    return;
  }

  dom.btnSend.disabled = true;
  dom.spinner.style.display = 'inline-block';

  resetToggleState(); 

  const convertedName = convertToWorkflowyBullets(text);

  const payload = {
    parent_id: config.parentId,
    name: convertedName,
    position: config.position,
    data: {
      layoutMode: "bullets"
    }
  };
  
  const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${config.apiKey}`
  };

  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errText = await response.text();
      throw new Error(`Error ${response.status}: ${errText}`);
    }

    showToast('ÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ');
    // ÊàêÂäüÊôÇÔºö„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®„Å®„Éï„Ç©„Éº„Ç´„ÇπÔºà„Ç≠„Éº„Éú„Éº„ÉâÁ∂≠ÊåÅÔºâ
    applyTemplate(config.templates[0]); 

  } catch (error) {
    console.error('ÈÄÅ‰ø°Â§±Êïó:', error);
    showToast('ÈÄÅ‰ø°Â§±Êïó: ' + error.message.substring(0, 50) + '...'); 
  } finally {
    dom.btnSend.disabled = false;
    dom.spinner.style.display = 'none';
    
    // üåü ‰øÆÊ≠£2: Âá¶ÁêÜ„ÅÆÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„Åã„Çâ„ÄÅÁ¢∫ÂÆü„Å´„Éï„Ç©„Éº„Ç´„Çπ„ÇíÊàª„Åô
    dom.editorMain.focus();
  }
}

function showToast(msg) {
  dom.toast.textContent = msg;
  dom.toast.classList.add('show');
  setTimeout(() => {
    dom.toast.classList.remove('show');
  }, 3000);
}

window.addEventListener('DOMContentLoaded', init);

document.getElementById('options-modal').addEventListener('click', (e) => {
  if (e.target.id === 'options-modal') {
    closeOptions();
  }
});

if (dom.templatesMenu) {
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#btn-templates') && !e.target.closest('#templates-menu')) {
      dom.templatesMenu.classList.remove('active');
    }
  });
}
</script>
</body>
</html>
